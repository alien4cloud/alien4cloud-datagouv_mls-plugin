tosca_definitions_version: alien_dsl_2_0_0

metadata:
  template_name: org.alien4cloud.plugin.datagouv_mls
  template_version: 3.0.0
  template_author: alien4cloud

description: |
  Types to expose services through openresty reverse proxy.

imports:
  - tosca-normative-types:1.0.0-ALIEN20
  - alien-base-types:3.0.0
  - yorc-types:1.1.0

node_types:

  org.alien4cloud.plugin.datagouv_mls.types.ReverseProxyConfigurator:
    derived_from: tosca.nodes.Root
    description: |
      A type that run a single shell command
    properties:
      kubeConfig:
        type: string
        description: |
          PD (plateform dependant), kube config with admin rigths.
      iamBaseUrl:
        type: string
        description: |
          ZD (zone dependant), the base url of the IAM, for example https://iam.metier.artemis
      smdUrl:
        type: string
        description: |
          PD (plateform dependant), the base url of the SMD, for example https://smd.technique.artemis:8080
      smdUser:
        type: string
        description: |
          PD, Username to authenticate with SMD.
      smdPassword:
        type: string
        description: |
          PD, Password to authenticate with SMD.
      portalClient:
        type: string
        description: |
          ZD
      portalSecret:
        type: string
        description: |
          ZD
      portalBaseUrl:
        type: string
        description: |
          ZD, the base URL for the portail (ex. https://portail.metier.artemis).
      serviceUpstreamUrl:
        type: string
        description: |
          UD (Usecase dependant), the internal URL to access the target service (ex. http://uc-ssa-kibana.cu-p-environment-ssa--ssaapp-metier.svc.cluster.local:5601/ssa-kibana/).
      proxyBaseUrl:
        type: string
        description: |
          ZD, the base URL of the proxy (ex. https://proxy.metier.artemis). Combined to the contextPath will give the full external URL to access the target.
      proxyBaseRedirectRegexp:
        type: string
        description: |
          ZD, expression used to detect proxy redirect (ex. ^https://[^.]+\.metier\.artemis(:[0-9]+)?/(.*)). Used in Nginx configuration proxy_redirect directive.
      dnsResolver:
        type: string
        description: |
          PD, the DNS resolver IP for Nginx configuration.
      zoneNamespace:
        type: string
        description: |
          ZD, the name space where the reverse proxy should be deployed (ex. pf-acc--portail-metier).
      deploymentName:
        type: string
        description: |
          UD, the deployment name, should be unique (use the module qualified name), and K8S naming policy compliant.
      imageUrl:
        type: string
        description: |
          PD, the full reverse proxy container image url (ex: hosted-registry.technique.artemis/artemis_plateforme_socle/socle/rp-artemis:v2.5.0_user500).
      contextPath:
        type: string
        description: |
          UD, the context path to access the target service (ex: /UL_Pilo0_IHM/).
      proxyHost:
        type: string
        description: |
          ZD, the external proxy host name (for example: proxy.cd.artemis).
